/*
 *  DESEncryption.c
 *  Encryption
 *
 *  Created by donglg on 10-6-30.
 *  Copyright 2010 __DZH__. All rights reserved.
 *
 */

#include "DESEncryption.h"

unsigned long g_outkey[16][2] = {0};
unsigned long g_bufkey[2] = {0};

static char wz_lefttable[16] = {1,1,2,2,2,2,2,2,1,2,2,2,2,2,2,1};
static unsigned long wz_leftandtab[3] = {0x0 , 0x80000000 , 0xc0000000 };
static char wz_keyleft[28] = 
{
57,49,41,33,25,17,9,1,58,50,42,34,26,18,
10,2,59,51,43,35,27,19,11,3,60,52,44,36
};

static char wz_keyright[28] = {
63,55,47,39,31,23,15,7,62,54,46,38,30,22,
14,6,61,53,45,37,29,21,13,5,28,20,12,4
};

static char wz_keychoose[48] ={
14,17,11,24,1,5,3,28,15,6,21,10,
23,19,12,4,26,8,16,7,27,20,13,2,
41,52,31,37,47,55,30,40,51,45,33,48,
44,49,39,56,34,53,46,42,50,36,29,32
};

static char wz_pc4[64] = {
40,8,48,16,56,24,64,32, 39,7,47,15,55,23,63,31,
38,6,46,14,54,22,62,30, 37,5,45,13,53,21,61,29,
36,4,44,12,52,20,60,28, 35,3,43,11,51,19,59,27,
34,2,42,10,50,18,58,26, 33,1,41,9,49,17,57,25
};
static char  wz_pc1[64] = {
58,50,42,34,26,18,10,2,60,52,44,36,28,20,12,4,
62,54,46,38,30,22,14,6,64,56,48,40,32,24,16,8,
57,49,41,33,25,17,9,1,59,51,43,35,27,19,11,3,
61,53,45,37,29,21,13,5,63,55,47,39,31,23,15,7 
};

static char wz_pc3[32] = {
16,7,20,21, 29,12,28,17, 1,15,23,26,
5,18,31,10, 2,8,24,14, 32,27,3,9,
19,13,30,6, 22,11,4,25
};

static unsigned long  wz_pc2[64] = { 
0x80000000L,0x40000000L,0x20000000L,0x10000000L, 0x8000000L, 
0x4000000L, 0x2000000L, 0x1000000L, 0x800000L, 0x400000L,
0x200000L, 0x100000L,  0x80000L, 0x40000L, 0x20000L,0x10000L, 
0x8000L, 0x4000L, 0x2000L, 0x1000L, 0x800L, 0x400L, 0x200L,
0x100L, 0x80L,0x40L,0x20L, 0x10L, 0x8L, 0x4L, 0x2L, 0x1L,
0x80000000L,0x40000000L,0x20000000L,0x10000000L, 0x8000000L,
0x4000000L, 0x2000000L, 0x1000000L, 0x800000L, 0x400000L,
0x200000L, 0x100000L,  0x80000L, 0x40000L, 0x20000L, 0x10000L, 
0x8000L, 0x4000L, 0x2000L, 0x1000L, 0x800L, 0x400L, 0x200L, 
0x100L, 0x80L, 0x40L,0x20L, 0x10L, 0x8L,  0x4L, 0x2L, 0x1L,     
}; 

static char exptab3[48] = {
32,1,2,3,4,5,4,5,6,7,8,9,8,9,10,11,12,13,
12,13,14,15,16,17,16,17,18,19,20,21,
20,21,22,23,24,25,24,25,26,27,28,29,
28,29,30,31,32,1 
};

static char SP[8][64] = 
{
{
0xe,0x0,0x4,0xf,0xd,0x7,0x1,0x4,0x2,0xe,0xf,0x2,0xb,
0xd,0x8,0x1,0x3,0xa,0xa,0x6,0x6,0xc,0xc,0xb,0x5,0x9,
0x9,0x5,0x0,0x3,0x7,0x8,0x4,0xf,0x1,0xc,0xe,0x8,0x8,
0x2,0xd,0x4,0x6,0x9,0x2,0x1,0xb,0x7,0xf,0x5,0xc,0xb,
0x9,0x3,0x7,0xe,0x3,0xa,0xa,0x0,0x5,0x6,0x0,0xd  
},

{ 
0xf,0x3,0x1,0xd,0x8,0x4,0xe,0x7,0x6,0xf,0xb,0x2,0x3,
0x8,0x4,0xf,0x9,0xc,0x7,0x0,0x2,0x1,0xd,0xa,0xc,0x6,
0x0,0x9,0x5,0xb,0xa,0x5,0x0,0xd,0xe,0x8,0x7,0xa,0xb,
0x1,0xa,0x3,0x4,0xf,0xd,0x4,0x1,0x2,0x5,0xb,0x8,0x6,
0xc,0x7,0x6,0xc,0x9,0x0,0x3,0x5,0x2,0xe,0xf,0x9
},
{ 
0xa,0xd,0x0,0x7,0x9,0x0,0xe,0x9,0x6,0x3,0x3,0x4,0xf,
0x6,0x5,0xa,0x1,0x2,0xd,0x8,0xc,0x5,0x7,0xe,0xb,0xc,
0x4,0xb,0x2,0xf,0x8,0x1,0xd,0x1,0x6,0xa,0x4,0xd,0x9,
0x0,0x8,0x6,0xf,0x9,0x3,0x8,0x0,0x7,0xb,0x4,0x1,0xf,
0x2,0xe,0xc,0x3,0x5,0xb,0xa,0x5,0xe,0x2,0x7,0xc                                          
},
{ 
0x7,0xd,0xd,0x8,0xe,0xb,0x3,0x5,0x0,0x6,0x6,0xf,0x9,
0x0,0xa,0x3,0x1,0x4,0x2,0x7,0x8,0x2,0x5,0xc,0xb,0x1,
0xc,0xa,0x4,0xe,0xf,0x9,0xa,0x3,0x6,0xf,0x9,0x0,0x0,
0x6,0xc,0xa,0xb,0xa,0x7,0xd,0xd,0x8,0xf,0x9,0x1,0x4,
0x3,0x5,0xe,0xb,0x5,0xc,0x2,0x7,0x8,0x2,0x4,0xe                         
},
{ 
0x2,0xe,0xc,0xb,0x4,0x2,0x1,0xc,0x7,0x4,0xa,0x7,0xb,
0xd,0x6,0x1,0x8,0x5,0x5,0x0,0x3,0xf,0xf,0xa,0xd,0x3,
0x0,0x9,0xe,0x8,0x9,0x6,0x4,0xb,0x2,0x8,0x1,0xc,0xb,
0x7,0xa,0x1,0xd,0xe,0x7,0x2,0x8,0xd,0xf,0x6,0x9,0xf,
0xc,0x0,0x5,0x9,0x6,0xa,0x3,0x4,0x0,0x5,0xe,0x3
},
{ 
0xc,0xa,0x1,0xf,0xa,0x4,0xf,0x2,0x9,0x7,0x2,0xc,0x6,
0x9,0x8,0x5,0x0,0x6,0xd,0x1,0x3,0xd,0x4,0xe,0xe,0x0,
0x7,0xb,0x5,0x3,0xb,0x8,0x9,0x4,0xe,0x3,0xf,0x2,0x5,
0xc,0x2,0x9,0x8,0x5,0xc,0xf,0x3,0xa,0x7,0xb,0x0,0xe,
0x4,0x1,0xa,0x7,0x1,0x6,0xd,0x0,0xb,0x8,0x6,0xd
},
{ 
0x4,0xd,0xb,0x0,0x2,0xb,0xe,0x7,0xf,0x4,0x0,0x9,0x8,
0x1,0xd,0xa,0x3,0xe,0xc,0x3,0x9,0x5,0x7,0xc,0x5,0x2,
0xa,0xf,0x6,0x8,0x1,0x6,0x1,0x6,0x4,0xb,0xb,0xd,0xd,
0x8,0xc,0x1,0x3,0x4,0x7,0xa,0xe,0x7,0xa,0x9,0xf,0x5,
0x6,0x0,0x8,0xf,0x0,0xe,0x5,0x2,0x9,0x3,0x2,0xc
},
{ 
0xd,0x1,0x2,0xf,0x8,0xd,0x4,0x8,0x6,0xa,0xf,0x3,0xb,
0x7,0x1,0x4,0xa,0xc,0x9,0x5,0x3,0x6,0xe,0xb,0x5,0x0,
0x0,0xe,0xc,0x9,0x7,0x2,0x7,0x2,0xb,0x1,0x4,0xe,0x1,
0x7,0x9,0x4,0xc,0xa,0xe,0x8,0x2,0xd,0x0,0xf,0x6,0xc,
0xa,0x9,0xd,0x0,0xf,0x3,0x3,0x5,0x5,0x6,0x8,0xb
} 
};

int des(char *data, char *key,int readlen)
{
	int i = 0;   
	makefirstkey((unsigned long*)key);
	for (i = 0; i < readlen; i += 8)
	{
		handle_data((unsigned long*)&data[i], DESENCRY);
	}
	return SUCCESS;
}

int Ddes(char *data,char *key,int readlen)
{
	int i = 0;
	makefirstkey((unsigned long*)key);  
	for (i = 0; i < readlen; i += 8)
	{
		handle_data((unsigned long*)&data[i] ,DESDECRY);
	}
	return SUCCESS;
}

int handle_data(unsigned long *left , int choice)
{
	int  number = 0 ,j = 0;   
	unsigned long *right = &left[1];
	unsigned long tmp = 0;       
	unsigned long tmpbuf[2] = { 0 };             
	
	for (j = 0; j < 64; j++)
	{
		if (j < 32 ) 
		{
			if (wz_pc1[j] > 32)
			{
				if (*right&wz_pc2[wz_pc1[j]-1] )
				{
					tmpbuf[0] |= wz_pc2[j];
				}
			}
			else
			{
				if (*left&wz_pc2[wz_pc1[j]-1])
				{
					tmpbuf[0] |= wz_pc2[j];
				}
			}
		}
		else
		{
			if (wz_pc1[j] > 32)
			{
				if (*right&wz_pc2[wz_pc1[j]-1])
				{
					tmpbuf[1] |= wz_pc2[j];
				}
			}
			else
			{
				if (*left&wz_pc2[wz_pc1[j]-1])
				{
					tmpbuf[1] |= wz_pc2[j];
				}
			}
		}
	}
	*left  = tmpbuf[0];
	*right = tmpbuf[1];
	tmpbuf[0] = 0;
	tmpbuf[1] = 0;
    switch(choice )
	{
		case DESENCRY:
			for (number = 0; number < 16; number++)
			{            
				makedata(left , right , (unsigned long)number);
			}
			break;
		case DESDECRY:
			for (number = 15; number >= 0; number--)
			{            
				makedata(left , right ,(unsigned long)number);
			}
			break;
		default:
			break;
	}
	
	tmp = *left;
	*left = *right;
	*right = tmp;        
	
	for (j = 0; j < 64; j++)
	{
		if (j < 32 ) 
		{
			if (wz_pc4[j] > 32)
			{
				if (*right&wz_pc2[wz_pc4[j]-1] )
				{
					tmpbuf[0] |= wz_pc2[j];
				}
			}
			else
			{
				if (*left&wz_pc2[wz_pc4[j]-1] )
				{
					tmpbuf[0] |= wz_pc2[j];
				}
			}
		}
		else
		{
			if (wz_pc4[j] > 32)
			{
				if (*right&wz_pc2[wz_pc4[j]-1] )
				{
					tmpbuf[1] |= wz_pc2[j];
				}
			}
			else
			{
				if (*left&wz_pc2[wz_pc4[j]-1] )
				{
					tmpbuf[1] |= wz_pc2[j];
				}
			}
		}
	}
	
	*left =  tmpbuf[0];
	*right = tmpbuf[1];
	
	return SUCCESS;
}


int makedata(unsigned long  *left ,unsigned long  *right ,unsigned long number) 
{
	int j; 
	unsigned long oldright = *right;         
	char rexpbuf[8] = { 0};
	unsigned long datatmp = 0;        
	unsigned long exp[2] = { 0};                         
	
	for (j = 0; j < 48; j++)
	{
		if (j < 24 )
		{
			if (*right&wz_pc2[exptab3[j]-1] )
			{
				exp[0] |= wz_pc2[j];
			}            
		}            
		else
		{
			if (*right&wz_pc2[exptab3[j]-1] )
			{
				exp[1] |= wz_pc2[j-24];
			}
		}
	}
	
	for (j = 0; j < 2; j++)
	{            
		exp[j] ^= g_outkey[number][j];
	}     
	
	exp[1] >>= 8;
	rexpbuf[7] = (char) (exp[1]&0x0000003fL);
	exp[1] >>= 6;
	rexpbuf[6] = (char) (exp[1]&0x0000003fL);
	exp[1] >>= 6;
	rexpbuf[5] = (char) (exp[1]&0x0000003fL);
	exp[1] >>= 6;
	rexpbuf[4] = (char) (exp[1]&0x0000003fL);
	exp[0]  >>=  8;
	rexpbuf[3] = (char) (exp[0]&0x0000003fL);     
	exp[0] >>= 6;
	rexpbuf[2] = (char) (exp[0]&0x0000003fL);
	exp[0] >>= 6;
	rexpbuf[1] = (char) (exp[0]&0x0000003fL);
	exp[0] >>= 6;
	rexpbuf[0] = (char) (exp[0]&0x0000003fL);     
	exp[0] = 0;
	exp[1] = 0;
	
	*right = 0;
	for (j = 0; j < 7; j++)
	{
		*right |= SP[j][rexpbuf[j]];
		*right <<= 4;
	}
	*right |= SP[j][rexpbuf[j]];
	
	datatmp = 0;
	for (j = 0; j < 32; j++)
	{
		if (*right&wz_pc2[wz_pc3[j]-1] )
		{
			datatmp |= wz_pc2[j];
		}
	}
	*right = datatmp;
	
	*right ^= *left;       
	*left = oldright;
	
	return SUCCESS;
}

int makefirstkey(unsigned long *keyP )
{
	unsigned long key[2] = {0};
	unsigned long *Pkey;
	unsigned long *Pbufkey;
	int j; 
	Pbufkey = (unsigned long*)g_bufkey;
	Pkey = (unsigned long*)key;
	
	InitIntArray(g_bufkey, 2);
	copyFromIntArray(key, keyP, 1);
	
	InitIntArray2(g_outkey, 16, 2);
	
	for(j = 0; j < 28; j++)
	{
		if (wz_keyleft[j] > 32 ) 
		{
			if (Pkey[1]&wz_pc2[wz_keyleft[j]-1] )
			{
				Pbufkey[0] |= wz_pc2[j];
			}
		}
		else
		{
			if (Pkey[0]&wz_pc2[wz_keyleft[j]-1] )
			{
				Pbufkey[0] |= wz_pc2[j];
			}
		}
		
		if (wz_keyright[j] > 32 ) 
		{
			if (Pkey[1]&wz_pc2[wz_keyright[j]-1] )
			{
				Pbufkey[1] |= wz_pc2[j];
			}
		}
		else
		{
			if (Pkey[0]&wz_pc2[wz_keyright[j]-1] )
			{
				Pbufkey[1] |= wz_pc2[j];
			}
		}
	}
	for (j = 0; j < 16; j++)
	{
		makekey(&Pbufkey[0],&Pbufkey[1] , j );
	}
	return SUCCESS;
}

void InitIntArray(unsigned long buf[], int nSize)
{
	for ( int i = 0; i < nSize; i++)
	{
		buf[i] = 0;
	}
}

void InitIntArray2(unsigned long buf[][2], int nSize1, int nSize2)
{
	for ( int i = 0; i < nSize1; i++)
	{
		for (int j = 0; j < nSize2; j++)
		{
			buf[i][j] = 0;
		}
	}
}

void copyFromIntArray(unsigned long toBuf[], unsigned long fromBuf[], int nSize)
{
	for ( int i = 0; i < nSize; i++)
	{
		toBuf[i] = fromBuf[i]; 
	}
}

int makekey(unsigned long *keyleft,unsigned long *keyright ,unsigned long number)
{
	unsigned long tmpkey[2] ={0};
	unsigned long *Ptmpkey = (unsigned long*)tmpkey;     
	unsigned long *Poutkey = (unsigned long*)&g_outkey[number]; 
	int j;        
	
	InitIntArray(tmpkey, 2);
	
	*Ptmpkey = *keyleft&wz_leftandtab[wz_lefttable[number]];           
	Ptmpkey[1] = *keyright&wz_leftandtab[wz_lefttable[number]];              
	if (wz_lefttable[number] == 1)
	{
		*Ptmpkey >>= 27;
		Ptmpkey[1] >>= 27;
	}
	else
	{
		*Ptmpkey >>= 26;
		Ptmpkey[1] >>= 26;                    
	}
	Ptmpkey[0] &= 0xfffffff0;
	Ptmpkey[1] &= 0xfffffff0;
	
	*keyleft <<= wz_lefttable[number];
	*keyright <<= wz_lefttable[number];
	*keyleft |= Ptmpkey[0];
	*keyright |= Ptmpkey[1];            
	Ptmpkey[0] = 0;
	Ptmpkey[1] = 0;
    
	for (j = 0; j < 48; j++)
	{
		if (j < 24 )
		{
			
			if (*keyleft&wz_pc2[wz_keychoose[j]-1])
			{
				Poutkey[0] |= wz_pc2[j];
			}                   
		}            
		
		else
		{                   
			if (*keyright&wz_pc2[(wz_keychoose[j]-28)])
			{
				Poutkey[1] |= wz_pc2[j-24];
			}                   
		}
	}
	return SUCCESS;
}

